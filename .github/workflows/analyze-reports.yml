name: Analyze Google Ads Reports with AI

on:
  workflow_dispatch:      # Permite correr manualmente
  schedule:
    - cron: "0 7 * * 1"   # Executa todas as segundas Ã s 7h UTC (1h depois do update-report)

jobs:
  analyze-reports:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install openai pandas matplotlib

      - name: Analyze Reports with GPT
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python - << 'EOF'
          import os, json, pandas as pd
          from openai import OpenAI

          print("ðŸ”¹ Iniciando anÃ¡lise de relatÃ³rios Google Ads...")

          client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))
          reports_dir = "ads_reports"
          summary_path = os.path.join(reports_dir, "summary_comparativo.json")

          # Verifica se existem relatÃ³rios
          if not os.path.exists(summary_path):
              raise FileNotFoundError("âŒ summary_comparativo.json nÃ£o encontrado! Corre primeiro o workflow 'Update Google Ads Reports'.")

          with open(summary_path, "r", encoding="utf-8") as f:
              summary = json.load(f)

          # Monta texto com dados agregados
          resumo = "### Dados Consolidados Google Ads (Ãºltimos 30 dias)\n\n"
          for acc in summary:
              resumo += f"**{acc['account_name']}** ({acc['account_id']})\n"
              resumo += f"- Cliques: {acc['total_clicks']}\n"
              resumo += f"- Custo total: â‚¬{acc['total_cost']:.2f}\n"
              resumo += f"- CTR mÃ©dio: {acc['avg_ctr']}%\n\n"

          prompt = f"""
          Ã‰s um especialista em Google Ads.
          Recebeste o seguinte resumo de desempenho:

          {resumo}

          Com base nestes dados:
          1. Faz uma anÃ¡lise comparativa entre as contas.
          2. Indica quais tÃªm melhor desempenho e porquÃª.
          3. DÃ¡ recomendaÃ§Ãµes prÃ¡ticas para otimizar campanhas, reduzir custos e melhorar CTR.
          4. Sugere prioridades de investimento com base na performance.
          """

          response = client.responses.create(
              model="gpt-4.1-mini",
              input=prompt,
          )

          ai_output = response.output_text

          # Grava o relatÃ³rio Markdown
          with open("ads_ai_insights.md", "w", encoding="utf-8") as f:
              f.write("# RelatÃ³rio de Insights Google Ads (Gerado por IA)\n\n")
              f.write(ai_output)

          print("âœ… RelatÃ³rio de IA gerado com sucesso!")
          EOF

      - name: Commit and push AI insights
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add ads_ai_insights.md || echo "Sem alteraÃ§Ãµes para adicionar"
          git commit -m "Update AI Ads Insights" || echo "Sem alteraÃ§Ãµes para commit"
          git push
