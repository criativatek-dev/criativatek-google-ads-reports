name: üîç Analisar Contas Google Ads (IA)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 8 * * 1"  # executa todas as segundas √†s 8h UTC

jobs:
  analyze-reports:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install pandas openai matplotlib seaborn

      - name: Analyze Google Ads JSON reports
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python - << 'EOF'
          import json, glob, pandas as pd, openai, os

          print("üîç A analisar relat√≥rios JSON...")

          files = glob.glob("*.json")
          all_reports = []

          for file in files:
              with open(file, "r", encoding="utf-8") as f:
                  data = json.load(f)
                  for row in data:
                      row["source_file"] = file
                      all_reports.append(row)

          df = pd.DataFrame(all_reports)
          summary = df.groupby("source_file")[["clicks","impressions","cost"]].sum()
          print(summary)

          openai.api_key = os.getenv("OPENAI_API_KEY")
          insights_prompt = f"""
          Analisa os seguintes dados de campanhas Google Ads (JSON resumido abaixo) e escreve um relat√≥rio detalhado com:
          - Principais campanhas e palavras-chave com melhor desempenho
          - Recomenda√ß√µes pr√°ticas de otimiza√ß√£o
          - Oportunidades de redu√ß√£o de custo
          - Sugest√µes baseadas em intelig√™ncia artificial para aumentar convers√µes

          Dados:
          {summary.to_markdown()}
          """

          response = openai.chat.completions.create(
              model="gpt-4o-mini",
              messages=[
                  {"role": "system", "content": "√âs um analista s√™nior de Google Ads com experi√™ncia em otimiza√ß√£o de campanhas."},
                  {"role": "user", "content": insights_prompt},
              ]
          )

          with open("ads_ai_insights.md", "w", encoding="utf-8") as f:
              f.write(response.choices[0].message.content)

          print("‚úÖ Relat√≥rio IA gerado com sucesso: ads_ai_insights.md")
          EOF

      - name: Commit and push AI insights
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add ads_ai_insights.md
          git commit -m "Update AI insights report"
          git push
